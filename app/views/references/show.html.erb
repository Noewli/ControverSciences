<% provide(:title, "Référence") %>
<div class="row">


<% if logged_in? %>
  <div class="col-xs-12 col-sm-12 col-md-4 col-lg-2">
    <%= link_to "Revenir à la controverse",
                timeline_path(@reference.timeline_id), class: "btn btn-block btn-primary" %>
    <br/>
    <br/>
    <div class="panel panel-default">
    <div class="panel-body page">
    <%= image_tag("icons/myicon-ribbon.svg", height: "24px")%> Il vous reste
    <%=12 - Vote.where( user_id: current_user.id, reference_id: @reference.id ).sum( :value ) %>
    crédits à distribuer aux analyses de cette référence
      <br/>
      <br/>
    <%= link_to "Récupérer tous mes crédits attribués aux analyses de cette référence", vote_path( id: 'all', reference_id: @reference.id), method: :delete,
                class: "btn btn-block btn-primary" %>
    </div>
    </div>
  </div>
  <div class="col-sm-10 col-sm-offset-1 col-md-10 col-lg-6 col-lg-offset-0">
<% else %>
  <div class="col-xs-12 col-sm-12 col-md-4 col-lg-2">
    <%= link_to "Revenir à la controverse",
                timeline_path(@reference.timeline_id), class: "btn btn-primary", style: "white-space: normal" %>
  </div>
  <div class="col-sm-10 col-sm-offset-1 col-md-10 col-lg-5 col-lg-offset-0">
<% end %>
  <div class="clearfix">
  <% if logged_in? %>
    <div class="btn-group">
      <%= link_to "Mon analyse".html_safe,
                  reference_path(:filter => 'mine'),
                  class: "btn btn-default #{ params[:filter] == "mine" ? "active" : nil }" %>
    </div>
        <div class="btn-group">
      <%= link_to "Les autres analyses".html_safe,
        reference_path,
        class: "btn btn-default #{ params[:filter] == nil ? "active" : nil }"  %>
    </div>
        <div class="btn-group">
      <%= link_to "Mes analyses favorites".html_safe,
        reference_path(:filter => 'my-vote'),
        class: "btn btn-default #{ params[:filter] == "my-vote" ? "active" : nil }"  %>
    </div>
  <% else %>
        <div class="btn-group">
          <button class="btn btn-default dropdown-toggle" type="button"
                  id="dropdownMenuTri" data-toggle="dropdown">
            Trier par
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" role="menu" >
            <li <%= params[:sort]=='score' || params[:sort].nil? ? "class=selected" : nil %> >
              <%= link_to "Les meilleurs compétiteurs (par défault)", reference_path(:sort=> 'score',
                                                                                     :order => params[:order]) %> </li>
            <li <%= params[:sort]=='created_at' ? "class=selected" : nil %> >
              <%= link_to "Date de création", reference_path(:sort=> 'created_at',
                                                             :order => params[:order]) %> </li>
          </ul>
        </div>
        <div class="btn-group">
          <button class="btn btn-default dropdown-toggle" type="button"
                  id="dropdownMenuOrder" data-toggle="dropdown">
            Ordre
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu" role="menu" >
            <li <%= params[:order]=='desc' || params[:order].nil? ? "class=selected" : nil %> >
              <%= link_to "Décroissant (par défault)", reference_path(:sort=> params[:sort], :order => 'desc') %> </li>
            <li <%= params[:order]=='asc' ? "class=selected" : nil %> >
              <%= link_to "Croissant", reference_path(:sort => params[:sort], :order => 'asc') %> </li>
          </ul>
        </div>
  <% end %>
  </div>
  <div>
    </br>
  </div>
  <div id="comments" class="panel panel-default">
    <div class="panel-body">
      <% if @comments.any? %>
          <div class="page">
          <%= render @comments, vote: logged_in? && params[:filter] != 'mine' ? true : false %>
          <%= paginate @comments, :params => {:seed => @seed } %>
          </div>
          <% if params[:filter] == "mine" %>
              <%= link_to "<span class=\"glyphicon glyphicon-pencil\" >
        </span> Modifier mon analyse".html_safe,
                          edit_comment_path(id: @comments.first ), class: "btn btn-success" %>
          <% else %>
              <%= link_to "<span class=\"glyphicon glyphicon-pencil\" >
        </span> Ecrire une analyse de cette référence".html_safe,
                          new_comment_path(reference_id: @reference.id ), class: "btn btn-success" %>
          <% end %>
      <% elsif params[:filter] == "my-vote" %>
          Vous n'avez pas encore voté
      <% elsif params[:filter] == "mine" %>
          <%= link_to "<span class=\"glyphicon glyphicon-pencil\" >
        </span> Vous n'avez pas encore écrit d'analyse de cette référence".html_safe,
                      new_comment_path(reference_id: @reference.id ) %>
      <% else %>
          <%= link_to "<span class=\"glyphicon glyphicon-pencil\" >
        </span> Il n'y a pas d'analyse à cette référence, soyez le premier ! ".html_safe,
                      new_comment_path(reference_id: @reference.id ) %>
      <% end %>
    </div>
  </div>
</div>
<div class="col-sm-10 col-sm-offset-1 col-md-10  col-lg-4 col-lg-offset-0">
  <% if logged_in? %>
    <div class="clearfix">
      <%= link_to "<span class=\"glyphicon glyphicon-pencil\" >
        </span> Ecrire une analyse de cette référence".html_safe,
                  new_comment_path(reference_id: @reference.id), class: "btn btn-success pull-right" %>
      </br>
      </br>
      <%= link_to "<span class=\"glyphicon glyphicon-eye-open\" >
        </span> Suivre les nouvelles analyses ajoutées à cette référence".html_safe,
                  following_references_path(reference_id: @reference.id),
                  method: :post, class: "btn btn-primary pull-right" %>
      </br>
      </br>
    </div>
  <% end %>
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title"> <%= @reference.title %> </h3>
  </div>
  <div class="panel-body">
    <ul class="list-group">
      <li class="list-group-item"> <div class="bold">
        Les auteurs de l'étude : </div> <%= @reference.author %> </li>
      <li class="list-group-item"> <div class="bold">
        Année de publication : </div> <%= @reference.display_year %> </li>
      <li class="list-group-item"> <div class="bold">
        Journal :
        </div> <%= @reference.journal %></li>
      <% unless @reference.abstract.empty? %>
          <li class="list-group-item">
            <div class="bold">
              Abstract (dans sa langue originale) :
            </div>
            <div class="justify">
              <%= @reference.abstract %>
            </div>
          </li>
      <% end %>
      <% unless @reference.doi.empty? %>
      <li class="list-group-item"> <div class="bold">
        Identifiant unique : </div> <%= @reference.doi %></li>
      <% end %>
      <li class="list-group-item"> <div class="bold"> Lien vers la référence :
        </div> <%= link_to @reference.url, @reference.url, target: "_blank" %></li>
      <li class="list-group-item"> <div class="bold">
        Controverse dans laquelle apparait cette référence : </div>
        <%= link_to @reference.timeline_name, @reference.timeline,
                    target: "_blank" %></li>
        <% if @reference.binary != '' %>
          <li class="list-group-item clearfix">
            <% if logged_in? %>
                <div class="clearfix">
                <%= form_for :binary, :url => binaries_path do |f| %>

                    <%= f.hidden_field :reference_id, value: @reference.id %>
                    <%= f.hidden_field :timeline_id, value: @reference.timeline_id %>
                    <% if @user_binary.nil? %>
                        <%= f.label "Comment cette référence répond à la question : " + @reference.timeline_name %>
                        <br/>
                        <strong>  <%= @reference.binary.split('&&')[0] %> </strong>
                        <strong class="pull-right">  <%= @reference.binary.split('&&')[1] %> </strong>
                    <% else %>
                          <%= f.label "Vous avez déjà donné votre avis sur comment cette référence répond à la question : " + @reference.timeline_name +
                                              " Mais vous avez peut-être changé d'avis" %>
                          <br/>
                          <strong>  <%= @reference.binary.split('&&')[0] %> </strong>
                          <strong class="pull-right">  <%= @reference.binary.split('&&')[1] %> </strong>
                    <% end %>
                    <div class="btn-group-justified" data-toggle="buttons">
                      <% unless @user_binary.nil? %>
                          <label class="btn btn-default btn-select"
                                 title="Retirer mon avis" data-toggle="tooltip">
                            <%= f.radio_button :value, checked_value = "none",
                                               {id: "none", autocomplete: "off"} %>
                            <%= image_tag("icons/myicon-no.svg", height: "28px")%>
                          </label>
                      <% end %>
                      <% binary_hash.each do |key, value| %>
                          <% if key < 3 %>
                              <label class="btn btn-default btn-select <%= @user_binary == key ? "selected" : nil %> cd-color<%= key %>"
                                     title="Je pense <%= value %> que <%= @reference.binary.split('&&')[0].downcase %>." data-toggle="tooltip">
                          <% elsif key > 3 %>
                              <label class="btn btn-default btn-select <%= @user_binary == key ? "selected" : nil %> cd-color<%= key %>"
                                     title="Je pense <%= value %> que <%= @reference.binary.split('&&')[1].downcase %>." data-toggle="tooltip">
                          <% else %>
                              <label class="btn btn-default btn-select <%= @user_binary == key ? "selected" : nil %> cd-color<%= key %>"
                                     title="Je pense que <%= value %>" data-toggle="tooltip">
                          <% end %>
                            <%= f.radio_button :value, checked_value = key,
                                               {id: key, autocomplete: "off"} %>
                            <%= image_tag("icons/myicon-r#{key}.svg", height: "28px")%>
                          </label>
                      <% end %>
                    </div>
                    <br/>
                    <div class="pull-right">
                      <% if @user_binary.nil? %>
                          <%= f.submit "Enregistrer cet avis", class: "btn btn-primary" %>
                      <% else %>
                          <%= f.submit "Enregistrer la modification", class: "btn btn-primary", name: "update" %>
                      <% end %>
                    </div>
                <% end %>
                </div>
            <% else %>
                    <span class="bold"> Comment cette référence répond à la question : <%= @reference.timeline_name -%>
                     </span></br>
                <br/>
                <strong>  <%= @reference.binary.split('&&')[0] %> </strong>
                <strong class="pull-right">  <%= @reference.binary.split('&&')[1] %> </strong>
                <div class="btn-group-justified" data-toggle="buttons">
                <% binary_hash.each do |key, value| %>
                      <% if key < 3 %>
                          <label class="btn btn-default cd-color<%= key %>"
                             title="<%= @reference["binary_#{key}".to_sym] -%> pensent <%= value %> que <%= @reference.binary.split('&&')[0].downcase %>." data-toggle="tooltip">
                        <% elsif key > 3 %>
                          <label class="btn btn-default cd-color<%= key %>"
                                 title="<%= @reference["binary_#{key}".to_sym] -%> pensent <%= value %> que <%= @reference.binary.split('&&')[1].downcase %>." data-toggle="tooltip">
                        <% else %>
                          <label class="btn btn-default cd-color<%= key %>"
                                 title="<%= @reference["binary_#{key}".to_sym] -%> pensent que <%= value %>" data-toggle="tooltip">
                        <% end %>
                      <%= image_tag("icons/myicon-r#{key}.svg", height: "28px")%>
                        <%= @reference["binary_#{key}".to_sym] -%>
                    </label>
                <% end %>
                </div>
            <% end %>
            <br/>
          </li>
        <% end %>
      <li class="list-group-item clearfix">
        <% if logged_in? %>
            <%= form_for :rating, :url => ratings_path do |f| %>

                <%= f.hidden_field :reference_id, value: @reference.id %>
                <%= f.hidden_field :timeline_id, value: @reference.timeline_id %>
                <% if @user_rating.nil? %>
                    <%= f.label "Que pensez vous la qualité scientifique de ce papier ?" %>
                <% else %>
                    Vous pensez que <%= star_hash[@user_rating].downcase %>.
                    <br/>
                    Mais vous avez peut être changé d'avis ?
                <% end %>
                <div class="btn-group-justified" data-toggle="buttons">
                  <% unless @user_rating.nil? %>
                      <label class="btn btn-default"
                             title="Retirer mon avis btn-select" data-toggle="tooltip">
                        <%= f.radio_button :value, checked_value = "none",
                                           {id: "none", autocomplete: "off"} %>
                        <%= image_tag("icons/myicon-no.svg", height: "28px")%>
                      </label>
                  <% end %>
                  <% star_hash.each do |key, value| %>
                      <label class="btn btn-default btn-select <%= @user_rating == key ? "selected" : nil %>"
                             title="<%= value %>" data-toggle="tooltip">
                            <%= f.radio_button :value, checked_value = key,
                                               {id: key, autocomplete: "off"} %>
                        <%= image_tag("icons/myicon-#{key}.svg", height: "28px")%>
                      </label>
                  <% end %>
                </div>
                <br/>
                <div class="pull-right">
                <% if @user_rating.nil? %>
                    <%= f.submit "Enregistrer cet avis", class: "btn btn-primary" %>
                <% else %>
                    <%= f.submit "Enregistrer la modification", class: "btn btn-primary", name: "update" %>
                <% end %>
                </div>
            <% end %>
            <% if @reference.user_id == current_user.id %>
                </li>
                <li class="list-group-item clearfix">
                <%= link_to "Modifier la référence", edit_reference_path(@reference.id), class: "btn btn-primary" %>
            <% end %>
        <% else %>
                <span class="bold"> Comment les contributeurs jugent la qualité scientifique de cette référence :
                 </span></br>
            <div class="btn-group-justified" data-toggle="buttons">
              <% star_hash.each do |key, value| %>
                  <label class="btn btn-default"
                         title="<%= @reference["star_#{key}".to_sym] -%> pensent que <%= value.downcase %>" data-toggle="tooltip">
                    <%= image_tag("icons/myicon-#{key}.svg", height: "28px")%>
                    <%= @reference["star_#{key}".to_sym] -%>
                  </label>
              <% end %>
            </div>
        <% end %>
      </li>
    </ul>
  </div>
  <div class="panel-footer clearfix">
    <span class="pull-right">
      <br/>
      Référence ajoutée par <%= link_to @reference.user_name, user_path(@reference.user_id) %>
    </span>
    <button class="btn btn-default stick" data-placement="left"
            data-toggle="tooltip" title="<%= @reference.nb_contributors %> contributeurs" >
      <%= image_tag("icons/myicon-users.svg", alt: "ref", height: "32px") %>
      <%= @reference.nb_contributors %>
    </button>
    <button class="btn btn-default stick" data-placement="top"
            data-toggle="tooltip" title="<%= @reference.nb_edits %> analyses" >
      <%= image_tag("icons/myicon-comment.svg", alt: "ref", height: "32px") %>
      <%= @reference.nb_edits %>
    </button>
    <button class="btn btn-default stick" data-placement="right"
            data-toggle="tooltip" title="<%= @reference.nb_votes %> crédits accordés au total" >
      <%= image_tag("icons/myicon-ribbon.svg", alt: "ref", height: "32px") %>
      <%= @reference.nb_votes %>
    </button>
  </div>
</div>
</div>

</div>

<%= javascript_tag do %>
    $(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip({container: 'body'})
    })
<% end %>