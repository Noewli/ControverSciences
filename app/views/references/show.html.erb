<% provide(:title, @reference.title) %>
<div class="row">
  <% if logged_in? %>
      <div class="col-xs-12 col-sm-12 col-md-4 col-lg-2">
        <%= render 'layouts/panel' %>
      </div>
      <div class="col-xs-12 col-sm-12 col-md-8 col-lg-8">
  <% else %>
      <div class="col-xs-12 col-sm-10 col-md-10 col-lg-8 col-sm-offset-1 col-lg-offset-2">
  <% end %>

<div class="col-sm-10 col-sm-offset-1 col-md-10 col-lg-7 col-lg-offset-0">
  <div class="panel panel-<%= @rating_hash[:panel] -%>">
    <div class="panel-heading">
      <h3 class="panel-title"> La meilleur analyse </h3>
    </div>
    <div class="panel-body">
      <% if @comment.nil? %>
          <%= link_to "<span class=\"glyphicon glyphicon-plus\" ></span> Pas encore d'analyse dans cette section, soyez le premier".html_safe,
                      new_comment_path( reference_id: @reference.id, timeline_id: @reference.timeline_id ) %>
          </div>
      <% else %>
          <ol class="comments">
          <%= render @comment, ref: false, view: true, fork: true, diff: false %>
          </ol>
          </div>
          <div class="panel-footer">
            <span class="pull-right">
              Analyse ajouté par <%= @comment.user_name %>
            </span>
            <div class="clearfix"></div>
          </div>
      <% end %>
  </div>
  <div class="panel panel-<%= @rating_hash[:panel] -%>">
    <div class="panel-heading">
      <h3 class="panel-title"> Vos analyses </h3>
    </div>
    <div class="panel-body">
      <span>
            <%= link_to '<span class="glyphicon glyphicon-plus" ></span> Ajouter votre analyse'.html_safe,
                        new_comment_path( reference_id: @reference.id, timeline_id: @reference.timeline_id ) %>
      </span> </br>
      <% if @comments_user.any? %>
          <ol class="comments">
          <%= render @comments_user, ref: false, view: true, fork: true, diff: false %>
          </ol>
      <% end %>
    </div>
  </div>
  <div class="panel panel-<%= @rating_hash[:panel] -%>">
    <div class="panel-heading">
      <h3 class="panel-title"> les autres analyses </h3>
    </div>
    <div class="panel-body">
      <span>
        <%= link_to "<span class=\"glyphicon glyphicon-eye-open\" >
        </span> Suivre les nouvelles analyses apportées à cette référence".html_safe,
                    following_references_path( reference_id: @reference.id ), method: :post %>
      </span> </br>
      <% if @comments.any? %>
          <ol class="comments">
          <%= render @comments, ref: false, view: true, fork: true, diff: false %>

          <%= link_to "Il y a d'autres analyses, assouvisez votre
                      soif de connaissance etdecouvrez les",
                      comments_path(reference_id: @reference.id) %>
      <% end %>
    </div>
  </div>
</div>
<div class="col-sm-10 col-sm-offset-1 col-md-10  col-lg-5 col-lg-offset-0">
<div class="panel panel-<%= @rating_hash[:panel] -%>">
  <div class="panel-heading">
    <h3 class="panel-title"> La référence </h3>
  </div>
  <div class="panel-body">
    <ul class="list-group">
      <li class="list-group-item"> <div class="bold">
        Titre : </div> <%= @reference.title_fr %></li>
      <li class="list-group-item"> <div class="bold">
        Titre original de la référence : </div> <%= @reference.title %></li>
      <li class="list-group-item"> <div class="bold">
        Les auteurs de l'étude : </div> <%= @reference.author %> </li>
      <li class="list-group-item"> <div class="bold">
        Année de publication : </div> <%= @reference.year %> </li>
      <li class="list-group-item"> <div class="bold">
        Journal qui a osé éditer cette bouse :
        </div> <%= @reference.journal %></li>
      <% unless @reference.abstract.empty? %>
      <li class="list-group-item"> <div class="bold">
        Abstract (dans sa langue original) :
        </div> <%= @reference.abstract %></li>
      <% end %>
      <li class="list-group-item"> <div class="bold">
        Doi : </div> <%= @reference.doi %></li>
      <li class="list-group-item"> <div class="bold"> Lien vers la référence :
        </div> <%= link_to @reference.url, @reference.url, target: "_blank" %></li>
      <li class="list-group-item"> <div class="bold">
        Timeline dans laquelle apparait cet article : </div>
        <%= link_to @reference.timeline.name, @reference.timeline,
                    target: "_blank" %></li>
      <li class="list-group-item">
        <div class="bold"> Ce que les contributeurs pensent de cette réfèrence :
        </div>
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-danger"
               style="width: <%= @rating_hash[1] -%>% ;">
            <%= @reference.star_1 -%>
          </div>
          <div class="progress-bar progress-bar-striped progress-bar-warning"
               style="width: <%= @rating_hash[2] -%>% ;">
            <%= @reference.star_2 -%>
          </div>
          <div class="progress-bar progress-bar-default"
               style="width: <%= @rating_hash[3] -%>% ;">
            <%= @reference.star_3 -%>
          </div>
          <div class="progress-bar progress-bar-striped progress-bar-info"
               style="width: <%= @rating_hash[4] -%>% ;">
            <%= @reference.star_4 -%>
          </div>
          <div class="progress-bar progress-bar-striped progress-bar-primary"
               style="width: <%= @rating_hash[5] -%>% ;">
            <%= @reference.star_5 -%>
          </div>
        </div>
        <% if logged_in? %>
            <%= form_for :rating, :url => ratings_path do |f| %>

                <%= f.hidden_field :reference_id, value: @reference.id %>
                <%= f.hidden_field :timeline_id, value: @reference.timeline_id %>
                <% if @rating_hash[:user_value].nil? %>
                    <%= f.label "Que pensez vous de ce papier ?" %>
                <% else %>
                    <%= f.label "Vous avez déjà donné #{@rating_hash[:user_value]} étoiles à ce papier. Mais vous avez peut être changé d'avis ?" %>
                <% end %>
                <%= f.select :value, [["Je trouve qu'il rape un peu les fesses quand on se torche avec (1 étoile)", 1],
                                      ["Heuresement pour eux que je n'étais pas un des reviewers (2 étoiles)", 2],
                                      ["Ils se sont quand même pas foulés trois neurones pour le pondre (3 étoiles)", 3],
                                      ["Des bons petits gars et du bon boulot (4 étoiles)", 4],
                                      ["J'ai eu un orgasme cérébrale en le lisant (5 étoiles)", 5]
                                     ].delete_if{ |select| select[1] == @rating_hash[:user_value] },
                             {}, {class: 'form-control'} %>
                <% if @rating_hash[:user_value].nil? %>
                    <%= f.submit "Enregistrer cet avis", class: "btn btn-primary" %>
                <% else %>
                    <%= f.submit "Enregistrer la modification", class: "btn btn-primary", name: "update" %>
                <% end %>
          <% end %>
        <% end %>
      </li>
    </ul>
  </div>
  <div class="panel-footer">
    <%= image_tag("icons/myicon-users.png", alt: "ref", height: "24px") %>
    <span class="badge"><%= @reference.nb_contributors %></span>
    <%= image_tag("icons/myicon-edit-rule.png", alt: "ref", height: "24px") %>
    <span class="badge"><%= @reference.nb_edits %></span>
    <%= image_tag("icons/myicon-votes.png", alt: "ref", height: "24px") %>
    <span class="badge"><%= @reference.nb_votes %></span>
    <span class="pull-right">
      Référence ajouté par <%= @reference.user_name %>
    </span>
    <div class="clearfix"></div>
  </div>
</div>
</div>

</div>
</div>

