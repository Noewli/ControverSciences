<% provide(:title, @reference.title) %>
<div class="row">

<div class="col-xs-12 col-sm-12 col-md-4 col-lg-2">
<% if logged_in? %>
<%= render 'layouts/panel' %>
<% end %>
</div>

<div class="col-sm-10 col-sm-offset-1 col-md-10 col-lg-5 col-lg-offset-0">
  <div class="clearfix">
  <div class="btn-group">
    <button class="btn btn-default dropdown-toggle" type="button"
            id="dropdownMenuTri" data-toggle="dropdown">
      Trier par
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu" role="menu" >
      <li <%= params[:sort]=='score' || params[:sort].nil? ? "class=selected" : nil %> >
        <%= link_to "Les meilleurs compétiteurs (par défault)", reference_path(:sort=> 'score',
                                                                              :order => params[:order]) %> </li>
      <li <%= params[:sort]=='created_at' ? "class=selected" : nil %> >
        <%= link_to "Date de création", reference_path(:sort=> 'created_at',
                                                      :order => params[:order]) %> </li>
    </ul>
  </div>
  <div class="btn-group">
    <button class="btn btn-default dropdown-toggle" type="button"
            id="dropdownMenuOrder" data-toggle="dropdown">
      Ordre
      <span class="caret"></span>
    </button>
    <ul class="dropdown-menu" role="menu" >
      <li <%= params[:order]=='desc' || params[:order].nil? ? "class=selected" : nil %> >
        <%= link_to "Décroissant (par défault)", reference_path(:sort=> params[:sort], :order => 'desc') %> </li>
      <li <%= params[:order]=='asc' ? "class=selected" : nil %> >
        <%= link_to "Croissant", reference_path(:sort => params[:sort], :order => 'asc') %> </li>
    </ul>
  </div>
  <% if logged_in? %>
  <div class="pull-right">
  <div class="btn-group">
    <% if params[:filter] %>
        <%= link_to "Toute les analyses (sauf les miennes)",
                    reference_path, class: "btn btn-default"  %>
    <% else %>
      <%= link_to "Uniquement les analyses pour lesquels j'ai voté",
                  reference_path(:filter => 'mine'), class: "btn btn-default"  %>
    <% end %>
  </div>
  </div>
  <% end %>
  <div>
    </br>
  </div>
  </div>
  <div class="panel panel-default">
    <h4> &nbsp Les analyses  écrites par les contributeurs : </h4>
    <div class="panel-body">
      <% if @comments.any? %>
          <ol class="comments">
          <%= render @comments, vote: logged_in? ? true : false %>
          </ol>
          <%= paginate @comments %>
      <% elsif params[:filter] %>
          Vous n'avez pas encore voté
      <% else %>
          <%= link_to "<span class=\"glyphicon glyphicon-plus\" >
        </span> Il n'y a pas d'analyse, soyez le premier ! ".html_safe,
                      new_comment_path %>
      <% end %>
    </div>
  </div>
</div>
<div class="col-sm-10 col-sm-offset-1 col-md-10  col-lg-3 col-lg-offset-0">
<div class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title"> <%= @reference.title_fr %> </h3>
  </div>
  <div class="panel-body">
    <ul class="list-group">
      <li class="list-group-item"> <div class="bold">
        Titre original de la référence : </div> <%= @reference.title %></li>
      <li class="list-group-item"> <div class="bold">
        Les auteurs de l'étude : </div> <%= @reference.author %> </li>
      <li class="list-group-item"> <div class="bold">
        Année de publication : </div> <%= @reference.year %> </li>
      <li class="list-group-item"> <div class="bold">
        Journal qui a osé éditer cette bouse :
        </div> <%= @reference.journal %></li>
      <% unless @reference.abstract.empty? %>
      <li class="list-group-item"> <div class="bold">
        Abstract (dans sa langue original) :
        </div> <%= @reference.abstract %></li>
      <% end %>
      <li class="list-group-item"> <div class="bold">
        Doi : </div> <%= @reference.doi %></li>
      <li class="list-group-item"> <div class="bold"> Lien vers la référence :
        </div> <%= link_to @reference.url, @reference.url, target: "_blank" %></li>
      <li class="list-group-item"> <div class="bold">
        Timeline dans laquelle apparait cet article : </div>
        <%= link_to @reference.timeline.name, @reference.timeline,
                    target: "_blank" %></li>
      <li class="list-group-item">
        <% if logged_in? %>
            <%= form_for :rating, :url => ratings_path do |f| %>

                <%= f.hidden_field :reference_id, value: @reference.id %>
                <%= f.hidden_field :timeline_id, value: @reference.timeline_id %>
                <% if @user_rating.nil? %>
                    <%= f.label "Que pensez vous de ce papier ?" %>
                <% else %>
                    <%= image_tag("icons/myicon-#{@user_rating}.svg", height: "28px") +
                                " : "+ star_hash[@user_rating] %>
                <% end %>
                <div class="btn-group-justified" data-toggle="buttons">
                  <% unless @user_rating.nil? %>
                      <label class="btn btn-default"
                             title="Retirer mon avis">
                        <%= f.radio_button :value, checked_value = "none",
                                           {id: "none", autocomplete: "off"} %>
                        <%= image_tag("icons/myicon-no.svg", height: "28px")%>
                      </label>
                  <% end %>
                  <% star_hash.each do |key, value| %>
                      <label class="btn btn-default <%= @user_rating == key ? "active" : nil %>"
                             title="<%= value %>">
                            <%= f.radio_button :value, checked_value = key,
                                               {id: key, autocomplete: "off"} %>
                        <%= image_tag("icons/myicon-#{key}.svg", height: "28px")%>
                      </label>
                  <% end %>
                </div>
                <% if @user_rating.nil? %>
                    <%= f.submit "Enregistrer cet avis", class: "btn btn-primary" %>
                <% else %>
                    <%= f.submit "Enregistrer la modification", class: "btn btn-primary", name: "update" %>
                <% end %>
            <% end %>
        <% else %>
                <span class="bold"> Les avis sur cette référence :
                 </span></br>
                <% for i in 1..5 %>
                    <%= image_tag("icons/myicon-#{i}.svg", height: "28px")%>
                    <%= @reference["star_#{i}".to_sym] -%>
                <% end %>
        <% end %>
      </li>
    </ul>
  </div>
  <div class="panel-footer">
    <%= image_tag("icons/myicon-users.svg", alt: "ref", height: "24px") %>
    <span class="badge"><%= @reference.nb_contributors %></span>
    <%= image_tag("icons/myicon-comment.svg", alt: "ref", height: "24px") %>
    <span class="badge"><%= @reference.nb_edits %></span>
    <%= image_tag("icons/myicon-ribbon.svg", alt: "ref", height: "24px") %>
    <span class="badge"><%= @reference.nb_votes %></span>
    <span class="pull-right">
      Référence ajouté par <%= @reference.user_name %>
    </span>
    <div class="clearfix"></div>
  </div>
</div>
</div>

<div class="col-sm-10 col-sm-offset-1 col-md-10 col-lg-2 col-lg-offset-0">
  <%= link_to "<span class=\"glyphicon glyphicon-plus\" >
        </span> Ecrire une analyse".html_safe,
              new_comment_path, class: "btn btn-block btn-primary" %>
  <%= link_to "<span class=\"glyphicon glyphicon-eye-open\" >
        </span> Suivre les nouvelles analyses".html_safe,
              following_references_path( reference_id: @reference.id ),
              method: :post, class: "btn btn-block btn-primary" %>
  <%= link_to "<span class=\"glyphicon glyphicon-eye-open\" >
        </span> Voir mes analyses".html_safe,
              comments_path( reference_id: @reference.id ), class: "btn btn-block btn-primary" %>
</div>

</div>
</div>

