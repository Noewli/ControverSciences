<% provide(:title, "Nouvelle analyse") %>
<div id="my-container" class="container-fluid">
  <div class="row">
    <div class="col-xs-12 col-sm-12 col-md-4 col-lg-2">
      <%= link_to "Revenir à la controverse",
                  timeline_path(@comment.timeline_id), class: "btn btn-block btn-primary", style: "white-space: normal" %>
      <br/>
      <br/>
      <%= link_to "Revenir à la référence",
                  reference_path(@comment.reference_id), class: "btn btn-block  btn-primary", style: "white-space: normal" %>

    </div>

    <div class="col-xs-12 col-sm-12 col-md-8 col-lg-10">
      <div class="row">
        <div class="col-md-12 col-lg-7">
          <div class="panel panel-default">
            <div class="panel-heading">
              <h2> Ecrire une analyse </h2>
              <br/>
              Pour la référence :

              <%= link_to Reference.where(id: @comment.reference_id).pluck(:title)[0],
                          reference_url(@comment.reference_id) %> <br>

              Dans la timeline :
              <%= link_to Timeline.where(id: @comment.timeline_id).pluck(:name)[0],
                          timeline_url(@comment.timeline_id) %>
            </div>
            <div class="panel-body">
              <%= form_for(@comment, html: {multipart: true}) do |f| %>
                  <%= render 'shared/error_messages', object: f.object %>
                  <div class="switcher pull-right">
                    <p class="fieldset">
                      <%= f.radio_button :public, true %>
                      <label for="comment_public_true">Public</label>
                      <%= f.radio_button :public, false %>
                      <label for="comment_public_false">Privée</label>
                      <span class="switch"></span>
                    </p>
                  </div>
                  <br/>
                  <br/>
                  <%= f.label "Phrase d'accroche" %>
                  <div id="characterLeft7"></div>

                  <%= f.text_area :title, {rows: 4, :class => "form-control textarea",
                                           id: "description7",
                                           "data-provide" => "markdown"} %>
                  <br/>
                  <% for fi in 0..5 %>
                      <%= f.label fields_hash[fi] %>
                      <div id="characterLeft<%= fi %>"></div>

                      <%= f.text_area "f_#{fi}_content".to_sym, {rows: 5,
                                                                 :placeholder => fi == 5 ? "e.g. Cette publication a été financée par une firme pharmaceutique, donc on peut douter de son objectivité" : fields_hash[fi],
                                                                 :class => "form-control textarea",
                                                                 id: "description#{fi}",
                                                                 "data-provide" => "markdown"} %>
                      <br/>
                  <% end %>
                  <%= f.hidden_field :has_picture, value: @comment.picture? %>
                  <%= f.hidden_field :delete_picture, value: false %>
                  <%= f.hidden_field :reference_id, value: @comment.reference_id %>
                  <%= f.hidden_field :timeline_id, value: @comment.timeline_id %>
                  <div id="caption" style="display: none">
                    <div class="row">
                      <div class="col-xs-12 col-md-6">
                        <div id="original">
                          <%= image_tag @comment.picture_url, class: "img-rounded img-responsive" %>
                        </div>
                        <div id="uploaded" style="display: none">
                          <%= image_tag '', class: "img-rounded img-responsive" %>
                        </div>
                      </div>
                      <div class="col-xs-12 col-md-6">
                        <strong> Légende de la figure </strong> <strong id="caption-name"></strong>
                        <br/>

                        <div id="characterLeft6"></div>
                        <%= f.text_area :caption, {rows: 5, :placeholder => "Légende de la figure",
                                                   :class => "form-control textarea", id: "description6",
                                                   "data-provide" => "markdown"} %>
                      </div>
                    </div>
                  </div>
                  <br/>
                  <br/>

                  <%= f.button "Publier mon analyse &nbsp <span class=\"glyphicon glyphicon-ok\" aria-hidden=\"true\"></span>".html_safe,
                               class: 'pull-right btn btn-success btn-lg',
                               data: {disable_with: "<span class=\"glyphicon glyphicon-save\" aria-hidden=\"true\"></span> &nbsp Publication en cours "} %>
              <% end %>
              <div>
                <div id="upload-btn" class="btn btn-info btn-lg fileinput-button">
                  <i class="glyphicon glyphicon-folder-open"></i>&nbsp
                  <span id="ajouter"> Ajouter une figure </span>
                  <input accept="image/jpeg,image/gif,image/png,image/svg" id="fileupload" type="file" name="figure[picture]" multiple>
                </div>
                <div id="progress" style="display: none">
                  <svg version="1.1" class="loader-like" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="40px" height="40px" viewBox="0 0 50 50" style="enable-background:new 0 0 50 50;" xml:space="preserve">
                    <path fill="#000" d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z">
                      <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.6s" repeatCount="indefinite"/>
                    </path>
                  </svg>
                </div>
                <div id="delete" class="btn btn-danger btn-lg" style="display: none">
                  <span class="glyphicon glyphicon-trash" aria-hidden="true"> </span>
                  Supprimer la figure
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="mylist" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel"> Créer un lien vers une référence </h4>
      </div>
      <div class="modal-body">
        <%= select("reference", "reference_id", @list, {}, {id: "list-ref", class: 'form-control'}) %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-dismiss="modal" data-toggled="no" id="save-btn"> Ajouter
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="myref" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel"> Ajouter un lien externe </h4>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <span class="input-group-addon">http://</span>
          <input id="http-text" type="text" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-success" data-dismiss="modal" data-toggled="no" id="save-btn-http">
          Ajouter
        </button>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript">
    $(document).ready(function() {
        if ($('#comment_has_picture').val() === 'true') {
            $('#caption').show();
            $('#delete').show();
            $('#ajouter').text("Modifier la figure");
        }
    });
    $(function () {
        'use strict';
        // Change this to the location of your server-side upload handler:
        $('#fileupload').fileupload({
            url: "<%= figures_url + "?reference_id=" + @comment.reference_id.to_s %>",
            type: 'POST',
            dataType: 'json',
            done: function (e, data) {
                $('#upload-btn').show(300);
                $('#comment_has_picture').val('true');
                $('#comment_delete_picture').val('false');
                $('#caption').show(300);
                $('#progress').hide(300);
                $('#original').hide(300);
                $('#uploaded').show(300);
                $('#uploaded img').attr("src", data.result.picture.url);
            },
            start: function (e, data) {
                $('#upload-btn').hide();
                $('#progress').show();
            }
        }).prop('disabled', !$.support.fileInput).parent().addClass($.support.fileInput ? undefined : 'disabled');
    });
    $('#delete').click(function () {
        $('#caption').hide(300);
        $('#delete').hide(300);
        $('#ajouter').text("Ajouter une figure à cette analyse");
        $('#comment_delete_picture').val('true');
    });
    var mysavebtn = document.getElementById('save-btn');
    $('#save-btn').on('click', function (event) {
        mysavebtn.setAttribute("data-toggled", 'yes');
    });
    var myref = document.getElementById('save-btn-http');
    $('#save-btn-http').on('click', function (event) {
        myref.setAttribute("data-toggled", 'yes');
    });
    $.each(['0', '1', '2', '3', '4', '5', '6', '7' ], function (index, value) {
        $(document).ready(function () {
            if (value === '7') {
                var max = 180;
            } else {
                var max = 1000;
            }
            var len = $('#description' + value).val().length;
            if (len >= max) {
                var ch = len - max;
                $('#characterLeft' + value).css({"color": "#a94442"});
                $('#characterLeft' + value).text(ch + ' caractères en trop !');
            } else {
                var ch = max - len;
                $('#characterLeft' + value).css({"color": "#5cb85c"});
                $('#characterLeft' + value).text(ch + ' caractères restants.');
            }
        });
        $('#description' + value).keyup(function () {
            if (value === '7') {
                var max = 180;
            } else {
                var max = 1000;
            }
            var len = $(this).val().length;
            if (len >= max) {
                var ch = len - max;
                $('#characterLeft' + value).css({"color": "#a94442"});
                $('#characterLeft' + value).text(ch + ' caractères en trop !');
            } else {
                var ch = max - len;
                $('#characterLeft' + value).css({"color": "#5cb85c"});
                $('#characterLeft' + value).text(ch + ' caractères restants.');
            }
        });
    });
</script>