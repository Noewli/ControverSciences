<%= javascript_include_tag 'chart' %>

<div class="panel panel-default">
  <div class="panel-heading clearfix">
    <% if logged_in? && current_user.id == @user.id %>
        <div class="pull-right">
          <%= link_to "<span class=\"fat icon-techno\"></span> Editer votre profil".html_safe,
                      edit_user_path(@user.id) ,class: "btn btn-default" %>
        </div>
    <% end %>
        <% if @user_detail && @user_detail.id && @user_detail.picture? %>
            <%= image_tag @user_detail.picture_url, class: "img-rounded", height: "80px" %>
        <% else %>
            <%= image_tag "favicon.svg", class: "img-rounded", height: "80px" %>
        <% end %>
    <span style="font-size: 3em">
      &nbsp <%= @user.name %>
    </span>
  </div>
  <div class="panel-body">
    <% if logged_in? && current_user.admin && current_user.id != @user.id %>
        <div class="panel panel-danger">
          <div class="panel-heading clearfix">
            <span class="glyphicon glyphicon-warning-sign"></span> Pour les admins seulement <br/>
            <a href="mailto:<%= @user.email %>"><%= @user.email %></a>
            <br/>
            <%= link_to "Se connecter en tant que #{@user.name}", login_for_admin_path(id:@user.id) %>
            <br/>
                <%= link_to "<span class=\"glyphicon glyphicon-trash\"></span>
                Supprimer ce contributeur".html_safe,
                            @user,
                            method: :delete,
                            class:  "pull-right btn btn-danger",
                            data:   {confirm: t('views.default.confirm')} %>
          </div>
        </div>
    <% end %>
    <% if @user_detail && @user_detail.id && @user_detail.job != "" %>
      <b> Fonction/métier : </b><br/>
            <%= @user_detail.job  %>
        <br/><br/>
    <% end %>
    <% if @user_detail && @user_detail.id && @user_detail.institution != "" %>
        <b> Institution : </b> <br/>
      <%= @user_detail.institution %>
      <br/><br/>
    <% end %>
    <% if  @user_detail && @user_detail.id && @user_detail.biography != "" %>
        <b> Biographie : </b> <%= @user_detail.content_markdown.html_safe %> <br/>
    <% end %>
    <% if  @user_detail && @user_detail.id && @user_detail.website != "" %>
      <b> Site web : </b><br/>
      <%= link_to @user_detail.website, @user_detail.website, target: "_blank" %> <br/><br/>
    <% end %>
    <br/>
    <% if @user_detail && !@user_detail.profil.blank? %>
      <div class="row">
        <div class="col-xs-12 col-sm-offset-2 col-sm-8 col-md-offset-1 col-md-10 col-lg-offset-2 col-lg-8">
          <canvas id="myChart"></canvas>
        </div>
      </div>
      <script type="text/javascript">
          var data = {
              labels: [
                  <% (1..8).each do |n| %>
                  "<%= user_profils[n] %>",
                  <% end %>
                  "<%= user_profils[9] %>"
              ],
              datasets: [
                  {
                      label: "<%= @user.name %>",
                      fillColor: "rgba(151,187,205,0.2)",
                      strokeColor: "rgba(151,187,205,1)",
                      pointColor: "rgba(151,187,205,1)",
                      pointStrokeColor: "#fff",
                      pointHighlightFill: "#fff",
                      pointHighlightStroke: "rgba(151,187,205,1)",
                      data: [
                          <% (1..8).each do |n| %>
                          "<%= (0.5 + Float(@user_detail.profil[n.to_s])).round(2) %>",
                          <% end %>
                          "<%= (0.5 + Float(@user_detail.profil["9"])).round(2) %>"
                      ]
                  }
              ]
          },
          labels = <%= raw user_profil_info %>;
          Chart.defaults.global.responsive = true;
          Chart.defaults.global.tooltipTemplate = "<%%if (toolLabel){%><%%=toolLabel%><%%}%>";
          Chart.defaults.global.scaleOverride = true;
          // Number - The number of steps in a hard coded scale
          Chart.defaults.global.scaleSteps = 5;
          // Number - The value jump in the hard coded scale
          Chart.defaults.global.scaleStepWidth = 0.3;
          // Number - The scale starting value
          Chart.defaults.global.scaleStartValue = 0;
          var canvas = $("#myChart").get(0),
              ctx = canvas.getContext('2d'),
              myRadarChart = new Chart(ctx).Radar(data, {pointLabelFontSize : 14, pointLabelFontStyle : "bold"});
          $.each(myRadarChart.datasets[0].points, function( key, point ) {
              point.toolLabel = labels[key];
          });
      </script>

  <% end %>
    <br/>
    <br/>
    <div class="panel-group" role="tablist" aria-multiselectable="true">
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingOne">
          <h4 class="panel-title clearfix">
            <a data-toggle="collapse" href="#collapseOne" class="pull-right glyphicon glyphicon-chevron-down"></a>
            <a data-toggle="collapse" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
              <%= @user.name %> a ajouté <%= pluralize(
                                    @timelines.length, "controverse") %>
            </a>
          </h4>
        </div>
        <div id="collapseOne" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingOne">
          <table id="notification-timelines" class="table table-striped table-hover">
            <thead>
            <tr>
              <th class="col-sm-8"> Nom </th>
              <th class="col-sm-3"> Tags </th>
            </tr>
            </thead>

            <tbody class="page">
            <% if !@timelines.any? %>
                <tr class="notification-timeline">
                  <td> Auncune controverses </td>
                  <td>  </td>
                </tr>
            <% else %>
                <% @timelines.each do |timeline| %>
                    <tr class="notification-timeline">
                      <td> <%= link_to timeline.name.html_safe, timeline_path(timeline) %> </td>
                      <td>
                        <% timeline.get_tag_list.each do |name| %>
                            <span class="icon-<%= name %>"></span>
                        <% end %>
                      </td>
                    </tr>
                <% end %>
            <% end %>
            </tbody>
          </table>
        </div>
      </div>
      <br/>
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingThree">
          <h4 class="panel-title clearfix">
            <a data-toggle="collapse" href="#collapseFour" class="pull-right glyphicon glyphicon-chevron-down"></a>
            <a class="collapsed" data-toggle="collapse" href="#collapseFour" aria-expanded="false" aria-controls="collapseThree">
              <%= @user.name %> a écrit <%= pluralize(
                                                    @summaries.length, "synthèse")%> de controverses
            </a>
          </h4>
        </div>
        <div id="collapseFour" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingFour">
          <table id="notification-summaries" class="table table-striped table-hover">
            <thead>
            <tr>
              <th class="col-xs-5"> Synthèse </th>
              <th class="col-xs-5"> De la controverse </th>
            </tr>
            </thead>
            <tbody class="page">
            <% if !@summaries.any? %>
                <tr class="notification-summary">
                  <td> Aucune synthèses </td>
                  <td>  </td>
                </tr>
            <% else %>
                <% @summaries.each do |com| %>
                    <td> <%= link_to "Voir la synthèse", summary_path(com.id ), class: "btn btn-primary" %>   </td>
                    <td> <%= link_to com.timeline_name.html_safe, timeline_path(com.timeline_id ) %>   </td>
                    </tr>
                <% end %>
            <% end %>
            </tbody>
          </table>
        </div>
      </div>
      <br/>
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingTwo">
          <h4 class="panel-title clearfix">
            <a data-toggle="collapse" href="#collapseTwo" class="pull-right glyphicon glyphicon-chevron-down"></a>
            <a class="collapsed" data-toggle="collapse" href="#collapseTwo" aria-expanded="false" aria-controls="collapseTwo">
              <%= @user.name %> a ajouté  <%= pluralize(
                                                      @references.length, "référence") %>
            </a>
          </h4>
        </div>
        <div id="collapseTwo" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingTwo">
          <table id="notification-references" class="table table-striped table-hover">
            <thead>
            <tr>
              <th class="col-xs-6"> La référence </th>
              <th class="col-xs-4"> Dans la controverse </th>
            </tr>
            </thead>

            <tbody class="page">
            <% if !@references.any? %>
                <tr class="notification-reference">
                  <td> Aucune références ajoutées  </td>
                  <td></td>
                </tr>
            <% else %>
                <% @references.each do |reference| %>
                    <tr class="notification-reference">
                      <td> <%= link_to reference.title, reference_path(reference) %>   </td>
                      <td> <%= link_to reference.timeline_name.html_safe, timeline_path(reference.timeline_id ) %>   </td>
                    </tr>
                <% end %>
            <% end %>
            </tbody>
          </table>
        </div>
      </div>
      <br/>
      <div class="panel panel-default">
        <div class="panel-heading" role="tab" id="headingThree">
          <h4 class="panel-title clearfix">
            <a data-toggle="collapse" href="#collapseThree" class="pull-right glyphicon glyphicon-chevron-down"></a>
            <a class="collapsed" data-toggle="collapse" href="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
              <%= @user.name %> a écrit <%= pluralize(
                                    @comments.length, "analyse") %> de références
            </a>
          </h4>
        </div>
        <div id="collapseThree" class="panel-collapse collapse" role="tabpanel" aria-labelledby="headingThree">
          <table id="notification-comments" class="table table-striped table-hover">
            <thead>
            <tr>
              <th class="col-xs-3"> L'analyse </th>
              <th class="col-xs-4"> De la référence </th>
            </tr>
            </thead>

            <tbody class="page">
            <% if !@comments.any? %>
                <tr class="notification-comment">
                  <td> Aucune analyses </td>
                  <td>  </td>
                </tr>
            <% else %>
                <% @comments.each do |com| %>
                    <tr class="notification-comment">
                      <td> <%= link_to "Voir l'analyse", comment_path(com.id ), class: "btn btn-primary" %>   </td>
                      <td> <%= link_to com.reference_title, reference_path(com.reference_id) %>   </td>
                    </tr>
                <% end %>
            <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
    $('.collapse').on('show.bs.collapse', function () {
        $(this).parent(".panel").find(".glyphicon-chevron-down").removeClass("glyphicon-chevron-down").addClass("glyphicon-chevron-up");

    });
    $('.collapse').on('hide.bs.collapse', function () {
        $(this).parent("div").parent("div").find(".glyphicon-chevron-up").removeClass("glyphicon-chevron-up").addClass("glyphicon-chevron-down");
    });
</script>